# FilterForward

## Compile
[Configure Streamer](https://github.com/viscloud/streamer#1-compile-streamer)
with the `-DUSE_CAFFE=yes` and `-DUSE_TENSORFLOW=yes` cmake options, then run
`make filterforward`.

## Run
In order to run FilterForward, you need the following
1. A base neural network (e.g., MobileNet), in Caffe, to generate feature
   vectors
2. A microclassifier (lightweight binary classifier), in TensorFlow, which takes
   a feature vector as input
3. A FilterForward configuration file

### Generating the microclassifier

A microclassifier is a binary classifier which takes as input a feature vector
consisting of a rectangular crop of the rows/columns of the activations
generated by the base neural network.

Properties:
1. The output of the microclassifier should be a probability between 0 and 1
2. The input tensor should be named `"Placeholder"`, and the output tensor
   should be named `"probabilities"`

A microclassifier has the same constraints as any other TensorFlow model used in
Streamer in that it should be a "frozen" graph (with the weights and
architecture in same file).

### Creating the FilterForward configuration file

Each line in the FilterForward configuration file should either be:
1. A comment prefixed by the character `"#"`.
2. A comma-separated list of indicating the configuration for a level in the
   hierarchy

Each non-comment row appends an additional layer to the hierarchy, and is
defined by the following column format:
0. Keyframe detector selectivity
1. Keyframe detector buffer length
2. Keyframe detector feature vector layer name
3. Number of copies of the microclassifier to run
4. Microclassifier feature vector crop window xmin
5. Microclassifier feature vector crop window ymin
6. Microclassifier feature vector crop window xmax
7. Microclassifier feature vector crop window ymax
8. "true" if the microclassifier feature vectors for this level  should be
   flattened to 1 dimenion, otherwise "false"
9. Path to the microclassifier model file
10. Microclassifier detection threshold

In the first level of the hierarchy, the keyframe detector parameters are
ignored because that level does not contain a keyframe detector.

### Sample call
```
filterforward --config-dir <path to config dir> --ff-conf <path to FilterForward config file> --model <name of base DNN> --fields <fields to backhaul> --output-dir <path to output dir> --camera <name of camera>
```

Run `filterforward -h` to see additional options, such as neural network batch
size.
